<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget Tracker - Import from File</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --bg-color: #ffffff;
            --text-color: #1f2937;
            --border-color: #e5e7eb;
            --hover-bg: #f3f4f6;
            --card-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            --success-bg: #d1fae5;
            --error-bg: #fee2e2;
        }

        [data-theme="dark"] {
            --bg-color: #1f2937;
            --text-color: #f9fafb;
            --border-color: #374151;
            --hover-bg: #374151;
            --card-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.5);
            --success-bg: #064e3b;
            --error-bg: #7f1d1d;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            transition: all 0.3s ease;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        h1 {
            color: var(--primary-color);
            font-size: 28px;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        button.secondary {
            background: var(--secondary-color);
        }

        button.danger {
            background: var(--danger-color);
        }

        button.warning {
            background: var(--warning-color);
        }

        .upload-section {
            background: var(--bg-color);
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .upload-section.drag-over {
            border-color: var(--primary-color);
            background: var(--hover-bg);
        }

        .upload-section h2 {
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin: 20px 0;
        }

        .file-input-wrapper input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-label {
            display: inline-block;
            padding: 12px 24px;
            background: var(--primary-color);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-input-label:hover {
            background: #1d4ed8;
            transform: translateY(-2px);
        }

        .file-info {
            margin-top: 15px;
            padding: 10px;
            background: var(--hover-bg);
            border-radius: 6px;
            display: none;
        }

        .file-info.active {
            display: block;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.active {
            display: block;
        }

        .alert.success {
            background: var(--success-bg);
            color: #065f46;
            border: 1px solid #10b981;
        }

        .alert.error {
            background: var(--error-bg);
            color: #991b1b;
            border: 1px solid #ef4444;
        }

        .grid-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 968px) {
            .grid-layout {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--card-shadow);
        }

        .card h2 {
            margin-bottom: 20px;
            color: var(--primary-color);
            font-size: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--hover-bg);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 14px;
            margin-top: 5px;
            opacity: 0.8;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background: var(--hover-bg);
            font-weight: 600;
        }

        tr:hover {
            background: var(--hover-bg);
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 30px;
        }

        .theme-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 100;
            width: 50px;
            height: 50px;
            font-size: 20px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-color);
            opacity: 0.6;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        footer {
            text-align: center;
            padding: 20px;
            border-top: 1px solid var(--border-color);
            margin-top: 40px;
        }

        .data-preview {
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 10px;
            background: var(--hover-bg);
        }

        .preview-row {
            padding: 5px;
            border-bottom: 1px solid var(--border-color);
            font-size: 12px;
        }

        .preview-row:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üí∞ Budget Tracker - Import from File</h1>
            <div class="header-buttons">
                <button class="secondary" onclick="exportData('json')">Export JSON</button>
                <button class="secondary" onclick="exportData('csv')">Export CSV</button>
                <button class="warning" onclick="clearReceiptData()">Clear Receipts</button>
                <button class="danger" onclick="clearData()">Clear All</button>
            </div>
        </header>

        <div class="alert success" id="successAlert"></div>
        <div class="alert error" id="errorAlert"></div>

        <section class="upload-section" id="uploadSection">
            <h2>üìÅ Import Budget Data</h2>
            <p>Upload a CSV or JSON file to import your budget data</p>
            
            <div class="file-input-wrapper">
                <input type="file" id="fileInput" accept=".csv,.json" onchange="handleFileSelect(event)">
                <label for="fileInput" class="file-input-label">Choose File</label>
            </div>
            
            <p style="margin-top: 10px; font-size: 14px; opacity: 0.7;">
                Or drag and drop your file here
            </p>

            <div class="file-info" id="fileInfo"></div>
        </section>

        <section class="upload-section" id="receiptUploadSection" style="margin-top: 20px;">
            <h2>üßæ Upload Receipts</h2>
            <p>Upload grocery receipts and utilities receipts (JSON format) for the past 6 months</p>
            
            <div class="file-input-wrapper">
                <input type="file" id="receiptInput" accept=".json" multiple onchange="handleReceiptSelect(event)">
                <label for="receiptInput" class="file-input-label">Choose Receipt Files</label>
            </div>
            
            <p style="margin-top: 10px; font-size: 14px; opacity: 0.7;">
                You can select multiple files at once (Ctrl/Cmd + Click)
            </p>

            <div class="file-info" id="receiptInfo"></div>
        </section>

        <section class="card">
            <h2>üìä Budget Overview</h2>
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-value" id="totalIncome">$0.00</div>
                    <div class="stat-label">Total Income</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalExpenses">$0.00</div>
                    <div class="stat-label">Total Expenses</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="netBalance">$0.00</div>
                    <div class="stat-label">Net Balance</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="transactionCount">0</div>
                    <div class="stat-label">Transactions</div>
                </div>
            </div>
        </section>

        <div class="grid-layout">
            <section class="card">
                <h2>üí∏ Expenses</h2>
                <div id="expensesTable">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <p>No expenses data yet. Import a file to get started!</p>
                    </div>
                </div>
            </section>

            <section class="card">
                <h2>üíµ Income</h2>
                <div id="incomeTable">
                    <div class="empty-state">
                        <div class="empty-state-icon">üí∞</div>
                        <p>No income data yet. Import a file to get started!</p>
                    </div>
                </div>
            </section>
        </div>

        <section class="card" id="receiptMetricsSection" style="display: none;">
            <h2>üìä Receipt Spending Metrics</h2>
            <div class="stats-grid" id="receiptStatsGrid">
                <div class="stat-card">
                    <div class="stat-value" id="totalGrocerySpending">$0.00</div>
                    <div class="stat-label">Total Grocery Spending</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalUtilitiesSpending">$0.00</div>
                    <div class="stat-label">Total Utilities Spending</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgGroceryPerTrip">$0.00</div>
                    <div class="stat-label">Avg Grocery per Trip</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgUtilitiesPerMonth">$0.00</div>
                    <div class="stat-label">Avg Utilities per Month</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="groceryReceiptCount">0</div>
                    <div class="stat-label">Grocery Receipts</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="utilitiesReceiptCount">0</div>
                    <div class="stat-label">Utilities Receipts</div>
                </div>
            </div>
        </section>

        <section class="card" id="receiptChartsSection" style="display: none;">
            <h2>üìà Receipt Analytics</h2>
            <div class="grid-layout">
                <div>
                    <h3 style="margin-bottom: 15px;">Grocery Spending by Category</h3>
                    <div class="chart-container">
                        <canvas id="groceryCategoryChart"></canvas>
                    </div>
                </div>
                <div>
                    <h3 style="margin-bottom: 15px;">Grocery Spending Over Time</h3>
                    <div class="chart-container">
                        <canvas id="groceryTimeChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="grid-layout" style="margin-top: 30px;">
                <div>
                    <h3 style="margin-bottom: 15px;">Utilities Spending by Provider</h3>
                    <div class="chart-container">
                        <canvas id="utilitiesProviderChart"></canvas>
                    </div>
                </div>
                <div>
                    <h3 style="margin-bottom: 15px;">Utilities Spending Over Time</h3>
                    <div class="chart-container">
                        <canvas id="utilitiesTimeChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <section class="card">
            <h2>üìà Visual Analytics</h2>
            <div class="grid-layout">
                <div>
                    <h3 style="margin-bottom: 15px;">Expense Categories</h3>
                    <div class="chart-container">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
                <div>
                    <h3 style="margin-bottom: 15px;">Monthly Overview</h3>
                    <div class="chart-container">
                        <canvas id="monthlyChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <footer>
            <p>Budget Tracker - Import from CSV/JSON | Last updated: <span id="lastUpdate"></span></p>
        </footer>
    </div>

    <button class="theme-toggle" onclick="toggleTheme()">üåô</button>

    <script>
        let budgetData = {
            expenses: [],
            income: []
        };
        let receiptData = {
            grocery: [],
            utilities: []
        };
        let categoryChart, monthlyChart;
        let groceryCategoryChart, groceryTimeChart, utilitiesProviderChart, utilitiesTimeChart;

        // Initialize app
        function initApp() {
            loadData();
            updateDisplay();
            setupDragAndDrop();
            updateLastUpdateDate();

            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                document.querySelector('.theme-toggle').textContent = '‚òÄÔ∏è';
            }
        }

        // Setup drag and drop
        function setupDragAndDrop() {
            const uploadSection = document.getElementById('uploadSection');
            
            uploadSection.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadSection.classList.add('drag-over');
            });

            uploadSection.addEventListener('dragleave', () => {
                uploadSection.classList.remove('drag-over');
            });

            uploadSection.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadSection.classList.remove('drag-over');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });
        }

        // Handle file selection
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        // Process file
        function handleFile(file) {
            const fileInfo = document.getElementById('fileInfo');
            fileInfo.innerHTML = `<strong>Selected:</strong> ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
            fileInfo.classList.add('active');

            const reader = new FileReader();
            const fileExtension = file.name.split('.').pop().toLowerCase();

            reader.onload = function(e) {
                try {
                    if (fileExtension === 'csv') {
                        parseCSV(e.target.result);
                    } else if (fileExtension === 'json') {
                        parseJSON(e.target.result);
                    } else {
                        showError('Unsupported file type. Please use CSV or JSON files.');
                        return;
                    }
                } catch (error) {
                    showError('Error processing file: ' + error.message);
                }
            };

            reader.onerror = function() {
                showError('Error reading file. Please try again.');
            };

            if (fileExtension === 'csv') {
                reader.readAsText(file);
            } else if (fileExtension === 'json') {
                reader.readAsText(file);
            } else {
                showError('Unsupported file type. Please use CSV or JSON files.');
            }
        }

        // Parse CSV file
        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            if (lines.length < 2) {
                showError('CSV file must have at least a header row and one data row.');
                return;
            }

            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const transactions = [];

            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length !== headers.length) continue;

                const transaction = {};
                headers.forEach((header, index) => {
                    const value = values[index].trim().replace(/"/g, '');
                    transaction[header.toLowerCase()] = value;
                });

                // Normalize transaction data
                const normalized = normalizeTransaction(transaction);
                if (normalized) {
                    transactions.push(normalized);
                }
            }

            importTransactions(transactions);
            showSuccess(`Successfully imported ${transactions.length} transactions from CSV!`);
        }

        // Parse CSV line handling quoted values
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result;
        }

        // Parse JSON file
        function parseJSON(jsonText) {
            try {
                const data = JSON.parse(jsonText);
                
                let transactions = [];
                
                // Handle different JSON structures
                if (Array.isArray(data)) {
                    // If it's an array of transactions
                    transactions = data.map(t => normalizeTransaction(t)).filter(t => t);
                } else if (data.expenses && data.income) {
                    // If it has expenses and income arrays
                    transactions = [
                        ...data.expenses.map(t => ({ ...normalizeTransaction(t), type: 'expense' })),
                        ...data.income.map(t => ({ ...normalizeTransaction(t), type: 'income' }))
                    ].filter(t => t);
                } else if (data.transactions) {
                    // If it has a transactions array
                    transactions = data.transactions.map(t => normalizeTransaction(t)).filter(t => t);
                } else {
                    showError('JSON structure not recognized. Expected array of transactions or object with expenses/income arrays.');
                    return;
                }

                importTransactions(transactions);
                showSuccess(`Successfully imported ${transactions.length} transactions from JSON!`);
            } catch (error) {
                showError('Invalid JSON format: ' + error.message);
            }
        }

        // Normalize transaction data from different formats
        function normalizeTransaction(transaction) {
            const normalized = {};
            
            // Map common field names
            const fieldMappings = {
                // Type/Transaction Type
                type: ['type', 'transactiontype', 'transaction_type', 'category_type'],
                // Name/Description
                name: ['name', 'description', 'desc', 'item', 'source', 'title'],
                // Amount
                amount: ['amount', 'value', 'price', 'cost'],
                // Category
                category: ['category', 'cat', 'expense_category', 'income_category'],
                // Date
                date: ['date', 'transaction_date', 'date_created', 'timestamp']
            };

            // Normalize keys to lowercase
            const lowerTransaction = {};
            Object.keys(transaction).forEach(key => {
                lowerTransaction[key.toLowerCase()] = transaction[key];
            });

            // Map fields
            Object.keys(fieldMappings).forEach(targetField => {
                const possibleKeys = fieldMappings[targetField];
                for (const key of possibleKeys) {
                    if (lowerTransaction[key] !== undefined) {
                        normalized[targetField] = lowerTransaction[key];
                        break;
                    }
                }
            });

            // Determine if expense or income
            if (!normalized.type) {
                // Try to infer from amount or category
                const typeStr = (normalized.type || '').toLowerCase();
                const categoryStr = (normalized.category || '').toLowerCase();
                const nameStr = (normalized.name || '').toLowerCase();
                
                if (typeStr.includes('income') || typeStr.includes('revenue') || 
                    categoryStr.includes('income') || categoryStr.includes('salary') ||
                    nameStr.includes('salary') || nameStr.includes('paycheck')) {
                    normalized.type = 'income';
                } else {
                    normalized.type = 'expense';
                }
            } else {
                normalized.type = normalized.type.toLowerCase();
                if (!['expense', 'income'].includes(normalized.type)) {
                    normalized.type = 'expense';
                }
            }

            // Validate required fields
            if (!normalized.amount || !normalized.name) {
                return null;
            }

            // Parse amount
            normalized.amount = parseFloat(normalized.amount);
            if (isNaN(normalized.amount)) {
                return null;
            }

            // Format date
            if (normalized.date) {
                normalized.date = formatDate(normalized.date);
            } else {
                normalized.date = new Date().toISOString().split('T')[0];
            }

            // Set default category if missing
            if (!normalized.category) {
                normalized.category = normalized.type === 'income' ? 'Income' : 'Uncategorized';
            }

            // Generate ID
            normalized.id = Date.now().toString(36) + Math.random().toString(36).substr(2);

            return normalized;
        }

        // Format date to YYYY-MM-DD
        function formatDate(dateStr) {
            try {
                const date = new Date(dateStr);
                if (isNaN(date.getTime())) {
                    return new Date().toISOString().split('T')[0];
                }
                return date.toISOString().split('T')[0];
            } catch {
                return new Date().toISOString().split('T')[0];
            }
        }

        // Import transactions
        function importTransactions(transactions) {
            transactions.forEach(transaction => {
                if (transaction.type === 'expense' || transaction.type === 'Expense') {
                    budgetData.expenses.push(transaction);
                } else if (transaction.type === 'income' || transaction.type === 'Income') {
                    budgetData.income.push(transaction);
                }
            });

            saveData();
            updateDisplay();
        }

        // Update display
        function updateDisplay() {
            updateStats();
            updateTables();
            updateCharts();
        }

        // Update statistics
        function updateStats() {
            const totalIncome = budgetData.income.reduce((sum, item) => sum + item.amount, 0);
            const totalExpenses = budgetData.expenses.reduce((sum, item) => sum + item.amount, 0);
            const netBalance = totalIncome - totalExpenses;
            const transactionCount = budgetData.expenses.length + budgetData.income.length;

            document.getElementById('totalIncome').textContent = `$${totalIncome.toFixed(2)}`;
            document.getElementById('totalExpenses').textContent = `$${totalExpenses.toFixed(2)}`;
            document.getElementById('netBalance').textContent = `$${netBalance.toFixed(2)}`;
            document.getElementById('transactionCount').textContent = transactionCount;

            const netBalanceEl = document.getElementById('netBalance');
            if (netBalance < 0) {
                netBalanceEl.style.color = 'var(--danger-color)';
            } else {
                netBalanceEl.style.color = 'var(--secondary-color)';
            }
        }

        // Update tables
        function updateTables() {
            updateExpensesTable();
            updateIncomeTable();
        }

        // Update expenses table
        function updateExpensesTable() {
            const container = document.getElementById('expensesTable');
            
            if (budgetData.expenses.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <p>No expenses data yet. Import a file to get started!</p>
                    </div>
                `;
                return;
            }

            let html = `
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Amount</th>
                                <th>Category</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            budgetData.expenses.forEach(expense => {
                html += `
                    <tr>
                        <td>${escapeHtml(expense.name)}</td>
                        <td>$${expense.amount.toFixed(2)}</td>
                        <td>${escapeHtml(expense.category || 'Uncategorized')}</td>
                        <td>${expense.date}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = html;
        }

        // Update income table
        function updateIncomeTable() {
            const container = document.getElementById('incomeTable');
            
            if (budgetData.income.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üí∞</div>
                        <p>No income data yet. Import a file to get started!</p>
                    </div>
                `;
                return;
            }

            let html = `
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Source</th>
                                <th>Amount</th>
                                <th>Category</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            budgetData.income.forEach(income => {
                html += `
                    <tr>
                        <td>${escapeHtml(income.name)}</td>
                        <td>$${income.amount.toFixed(2)}</td>
                        <td>${escapeHtml(income.category || 'Income')}</td>
                        <td>${income.date}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = html;
        }

        // Update charts
        function updateCharts() {
            updateCategoryChart();
            updateMonthlyChart();
        }

        // Update category chart
        function updateCategoryChart() {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            
            const categoryTotals = {};
            budgetData.expenses.forEach(expense => {
                const category = expense.category || 'Uncategorized';
                categoryTotals[category] = (categoryTotals[category] || 0) + expense.amount;
            });

            if (categoryChart) {
                categoryChart.destroy();
            }

            if (Object.keys(categoryTotals).length === 0) {
                return;
            }

            categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categoryTotals),
                    datasets: [{
                        data: Object.values(categoryTotals),
                        backgroundColor: [
                            '#2563eb', '#10b981', '#f59e0b', '#ef4444',
                            '#8b5cf6', '#ec4899', '#14b8a6', '#f97316',
                            '#6366f1', '#84cc16', '#06b6d4', '#f43f5e'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        }

        // Update monthly chart
        function updateMonthlyChart() {
            const ctx = document.getElementById('monthlyChart').getContext('2d');
            
            const monthlyData = getMonthlyData();
            
            if (monthlyChart) {
                monthlyChart.destroy();
            }

            if (monthlyData.length === 0) {
                return;
            }

            monthlyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: monthlyData.map(m => m.month),
                    datasets: [
                        {
                            label: 'Income',
                            data: monthlyData.map(m => m.income),
                            backgroundColor: '#10b981'
                        },
                        {
                            label: 'Expenses',
                            data: monthlyData.map(m => m.expenses),
                            backgroundColor: '#ef4444'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Get monthly data
        function getMonthlyData() {
            // Collect all unique months from the data
            const monthSet = new Set();
            
            budgetData.income.forEach(item => {
                if (item.date) {
                    const monthKey = item.date.slice(0, 7);
                    monthSet.add(monthKey);
                }
            });

            budgetData.expenses.forEach(expense => {
                if (expense.date) {
                    const monthKey = expense.date.slice(0, 7);
                    monthSet.add(monthKey);
                }
            });

            // If no data, return empty array
            if (monthSet.size === 0) {
                return [];
            }

            // Sort months chronologically
            const sortedMonths = Array.from(monthSet).sort();
            
            // Get the last 6 months (or all if less than 6)
            const monthsToShow = sortedMonths.slice(-6);
            
            const months = {};

            // Initialize months
            monthsToShow.forEach(monthKey => {
                const date = new Date(monthKey + '-01');
                const monthLabel = date.toLocaleString('default', { month: 'short', year: 'numeric' });
                
                months[monthKey] = {
                    month: monthLabel,
                    income: 0,
                    expenses: 0
                };
            });

            // Aggregate income by month
            budgetData.income.forEach(item => {
                if (item.date) {
                    const monthKey = item.date.slice(0, 7);
                    if (months[monthKey]) {
                        months[monthKey].income += item.amount;
                    }
                }
            });

            // Aggregate expenses by month
            budgetData.expenses.forEach(expense => {
                if (expense.date) {
                    const monthKey = expense.date.slice(0, 7);
                    if (months[monthKey]) {
                        months[monthKey].expenses += expense.amount;
                    }
                }
            });

            return monthsToShow.map(key => months[key]);
        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('budgetData', JSON.stringify(budgetData));
            updateLastUpdateDate();
        }

        // Load data from localStorage
        function loadData() {
            const saved = localStorage.getItem('budgetData');
            if (saved) {
                try {
                    budgetData = JSON.parse(saved);
                } catch (e) {
                    budgetData = { expenses: [], income: [] };
                }
            }
        }

        // Clear receipt data
        function clearReceiptData() {
            if (confirm('Are you sure you want to clear all receipt data? This action cannot be undone.')) {
                receiptData = { grocery: [], utilities: [] };
                saveReceiptData();
                document.getElementById('receiptMetricsSection').style.display = 'none';
                document.getElementById('receiptChartsSection').style.display = 'none';
                updateReceiptMetrics();
                showSuccess('All receipt data has been cleared.');
            }
        }

        // Export data
        function exportData(format) {
            const data = {
                expenses: budgetData.expenses,
                income: budgetData.income,
                exportDate: new Date().toISOString()
            };

            if (format === 'json') {
                const jsonStr = JSON.stringify(data, null, 2);
                downloadFile(jsonStr, 'budget-data.json', 'application/json');
            } else if (format === 'csv') {
                let csvContent = 'Type,Name,Amount,Category,Date\n';
                
                budgetData.expenses.forEach(expense => {
                    csvContent += `Expense,"${expense.name}",${expense.amount},"${expense.category || 'Uncategorized'}",${expense.date}\n`;
                });
                
                budgetData.income.forEach(income => {
                    csvContent += `Income,"${income.name}",${income.amount},"${income.category || 'Income'}",${income.date}\n`;
                });
                
                downloadFile(csvContent, 'budget-data.csv', 'text/csv');
            }
        }

        // Download file
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Clear all data
        function clearData() {
            if (confirm('Are you sure you want to clear all data? This action cannot be undone.')) {
                budgetData = { expenses: [], income: [] };
                saveData();
                updateDisplay();
                showSuccess('All data has been cleared.');
            }
        }

        // Show success message
        function showSuccess(message) {
            const alert = document.getElementById('successAlert');
            alert.textContent = message;
            alert.classList.add('active');
            setTimeout(() => alert.classList.remove('active'), 5000);
        }

        // Show error message
        function showError(message) {
            const alert = document.getElementById('errorAlert');
            alert.textContent = message;
            alert.classList.add('active');
            setTimeout(() => alert.classList.remove('active'), 5000);
        }

        // Toggle theme
        function toggleTheme() {
            const currentTheme = document.body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.body.setAttribute('data-theme', newTheme);
            document.querySelector('.theme-toggle').textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('theme', newTheme);
        }

        // Update last update date
        function updateLastUpdateDate() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = now.toLocaleString();
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Handle receipt file selection
        function handleReceiptSelect(event) {
            const files = event.target.files;
            if (files.length === 0) return;

            const receiptInfo = document.getElementById('receiptInfo');
            receiptInfo.innerHTML = `<strong>Selected:</strong> ${files.length} file(s)`;
            receiptInfo.classList.add('active');

            let processedCount = 0;
            let errorCount = 0;

            Array.from(files).forEach((file, index) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        processReceipts(data, file.name);
                        processedCount++;
                        
                        if (processedCount + errorCount === files.length) {
                            if (errorCount === 0) {
                                showSuccess(`Successfully processed ${processedCount} receipt file(s)!`);
                            } else {
                                showError(`Processed ${processedCount} file(s), ${errorCount} error(s).`);
                            }
                            updateReceiptMetrics();
                            saveReceiptData();
                        }
                    } catch (error) {
                        errorCount++;
                        console.error(`Error processing ${file.name}:`, error);
                        if (processedCount + errorCount === files.length) {
                            showError(`Error processing ${file.name}: ${error.message}`);
                        }
                    }
                };

                reader.onerror = function() {
                    errorCount++;
                    showError(`Error reading file: ${file.name}`);
                };

                reader.readAsText(file);
            });
        }

        // Process receipts from JSON data
        function processReceipts(data, filename) {
            // Handle array of receipts
            const receipts = Array.isArray(data) ? data : [data];

            receipts.forEach(receipt => {
                if (!receipt.receiptType) {
                    // Try to infer type from structure
                    if (receipt.store || receipt.items) {
                        receipt.receiptType = 'grocery';
                    } else if (receipt.provider || receipt.service || receipt.billingPeriod) {
                        receipt.receiptType = 'utilities';
                    } else {
                        return; // Skip if we can't determine type
                    }
                }

                if (receipt.receiptType === 'grocery') {
                    receiptData.grocery.push(receipt);
                    // Also add to expenses
                    if (receipt.total && receipt.date) {
                        budgetData.expenses.push({
                            id: Date.now().toString(36) + Math.random().toString(36).substr(2),
                            name: `Grocery - ${receipt.store || 'Store'}`,
                            amount: receipt.total,
                            category: 'Food',
                            date: receipt.date,
                            type: 'expense',
                            receiptNumber: receipt.receiptNumber || filename
                        });
                    }
                } else if (receipt.receiptType === 'utilities') {
                    receiptData.utilities.push(receipt);
                    // Also add to expenses
                    if (receipt.total && receipt.date) {
                        budgetData.expenses.push({
                            id: Date.now().toString(36) + Math.random().toString(36).substr(2),
                            name: `${receipt.service || 'Utilities'} - ${receipt.provider || 'Provider'}`,
                            amount: receipt.total,
                            category: 'Utilities',
                            date: receipt.date,
                            type: 'expense',
                            receiptNumber: receipt.accountNumber || filename
                        });
                    }
                }
            });
        }

        // Update receipt metrics
        function updateReceiptMetrics() {
            const totalGrocery = receiptData.grocery.reduce((sum, r) => sum + (r.total || 0), 0);
            const totalUtilities = receiptData.utilities.reduce((sum, r) => sum + (r.total || 0), 0);
            const groceryCount = receiptData.grocery.length;
            const utilitiesCount = receiptData.utilities.length;
            const avgGrocery = groceryCount > 0 ? totalGrocery / groceryCount : 0;
            
            // Calculate average utilities per month
            const utilitiesByMonth = {};
            receiptData.utilities.forEach(r => {
                if (r.date) {
                    const monthKey = r.date.slice(0, 7);
                    if (!utilitiesByMonth[monthKey]) {
                        utilitiesByMonth[monthKey] = [];
                    }
                    utilitiesByMonth[monthKey].push(r.total || 0);
                }
            });
            const monthlyUtilities = Object.values(utilitiesByMonth).map(month => 
                month.reduce((sum, val) => sum + val, 0)
            );
            const avgUtilities = monthlyUtilities.length > 0 
                ? monthlyUtilities.reduce((sum, val) => sum + val, 0) / monthlyUtilities.length 
                : 0;

            document.getElementById('totalGrocerySpending').textContent = `$${totalGrocery.toFixed(2)}`;
            document.getElementById('totalUtilitiesSpending').textContent = `$${totalUtilities.toFixed(2)}`;
            document.getElementById('avgGroceryPerTrip').textContent = `$${avgGrocery.toFixed(2)}`;
            document.getElementById('avgUtilitiesPerMonth').textContent = `$${avgUtilities.toFixed(2)}`;
            document.getElementById('groceryReceiptCount').textContent = groceryCount;
            document.getElementById('utilitiesReceiptCount').textContent = utilitiesCount;

            // Show receipt sections if we have data
            if (groceryCount > 0 || utilitiesCount > 0) {
                document.getElementById('receiptMetricsSection').style.display = 'block';
                document.getElementById('receiptChartsSection').style.display = 'block';
                updateReceiptCharts();
            }

            // Update main budget display
            updateDisplay();
        }

        // Update receipt charts
        function updateReceiptCharts() {
            updateGroceryCategoryChart();
            updateGroceryTimeChart();
            updateUtilitiesProviderChart();
            updateUtilitiesTimeChart();
        }

        // Update grocery category chart
        function updateGroceryCategoryChart() {
            const ctx = document.getElementById('groceryCategoryChart').getContext('2d');
            
            const categoryTotals = {};
            receiptData.grocery.forEach(receipt => {
                if (receipt.items && Array.isArray(receipt.items)) {
                    receipt.items.forEach(item => {
                        const category = item.category || 'Other';
                        categoryTotals[category] = (categoryTotals[category] || 0) + (item.price || 0);
                    });
                }
            });

            if (groceryCategoryChart) {
                groceryCategoryChart.destroy();
            }

            if (Object.keys(categoryTotals).length === 0) {
                return;
            }

            groceryCategoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categoryTotals),
                    datasets: [{
                        data: Object.values(categoryTotals),
                        backgroundColor: [
                            '#2563eb', '#10b981', '#f59e0b', '#ef4444',
                            '#8b5cf6', '#ec4899', '#14b8a6', '#f97316',
                            '#6366f1', '#84cc16', '#06b6d4', '#f43f5e'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        }

        // Update grocery time chart
        function updateGroceryTimeChart() {
            const ctx = document.getElementById('groceryTimeChart').getContext('2d');
            
            const monthlyData = {};
            receiptData.grocery.forEach(receipt => {
                if (receipt.date) {
                    const monthKey = receipt.date.slice(0, 7);
                    if (!monthlyData[monthKey]) {
                        const date = new Date(monthKey + '-01');
                        monthlyData[monthKey] = {
                            month: date.toLocaleString('default', { month: 'short', year: 'numeric' }),
                            total: 0
                        };
                    }
                    monthlyData[monthKey].total += receipt.total || 0;
                }
            });

            const sortedMonths = Object.keys(monthlyData).sort();
            const labels = sortedMonths.map(key => monthlyData[key].month);
            const data = sortedMonths.map(key => monthlyData[key].total);

            if (groceryTimeChart) {
                groceryTimeChart.destroy();
            }

            if (labels.length === 0) {
                return;
            }

            groceryTimeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Grocery Spending',
                        data: data,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Update utilities provider chart
        function updateUtilitiesProviderChart() {
            const ctx = document.getElementById('utilitiesProviderChart').getContext('2d');
            
            const providerTotals = {};
            receiptData.utilities.forEach(receipt => {
                const provider = receipt.provider || 'Unknown';
                providerTotals[provider] = (providerTotals[provider] || 0) + (receipt.total || 0);
            });

            if (utilitiesProviderChart) {
                utilitiesProviderChart.destroy();
            }

            if (Object.keys(providerTotals).length === 0) {
                return;
            }

            utilitiesProviderChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(providerTotals),
                    datasets: [{
                        label: 'Total Spending',
                        data: Object.values(providerTotals),
                        backgroundColor: '#2563eb'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Update utilities time chart
        function updateUtilitiesTimeChart() {
            const ctx = document.getElementById('utilitiesTimeChart').getContext('2d');
            
            const monthlyData = {};
            receiptData.utilities.forEach(receipt => {
                if (receipt.date) {
                    const monthKey = receipt.date.slice(0, 7);
                    if (!monthlyData[monthKey]) {
                        const date = new Date(monthKey + '-01');
                        monthlyData[monthKey] = {
                            month: date.toLocaleString('default', { month: 'short', year: 'numeric' }),
                            total: 0
                        };
                    }
                    monthlyData[monthKey].total += receipt.total || 0;
                }
            });

            const sortedMonths = Object.keys(monthlyData).sort();
            const labels = sortedMonths.map(key => monthlyData[key].month);
            const data = sortedMonths.map(key => monthlyData[key].total);

            if (utilitiesTimeChart) {
                utilitiesTimeChart.destroy();
            }

            if (labels.length === 0) {
                return;
            }

            utilitiesTimeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Utilities Spending',
                        data: data,
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Save receipt data
        function saveReceiptData() {
            localStorage.setItem('receiptData', JSON.stringify(receiptData));
        }

        // Load receipt data
        function loadReceiptData() {
            const saved = localStorage.getItem('receiptData');
            if (saved) {
                try {
                    receiptData = JSON.parse(saved);
                    if (receiptData.grocery && receiptData.utilities) {
                        updateReceiptMetrics();
                    }
                } catch (e) {
                    receiptData = { grocery: [], utilities: [] };
                }
            }
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
            loadReceiptData();
        });
    </script>
</body>
</html>
